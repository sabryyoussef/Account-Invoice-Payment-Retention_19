# دليل تقني - نظام إدارة المكتب الفني للمشاريع

## جدول المحتويات
1. [نظرة عامة على البنية](#نظرة-عامة-على-البنية)
2. [هيكل الوحدة](#هيكل-الوحدة)
3. [النماذج](#النماذج)
4. [الواجهات](#الواجهات)
5. [الأمان](#الأمان)
6. [سير العمل](#سير-العمل)
7. [نقاط التكامل](#نقاط-التكامل)
8. [دليل التخصيص](#دليل-التخصيص)
9. [استكشاف الأخطاء](#استكشاف-الأخطاء)

---

## نظرة عامة على البنية

نظام إدارة المكتب الفني مبني على إطار عمل Odoo 19 ويتبع أنماط تطوير Odoo القياسية:

- **بنية Model-View-Controller (MVC)**
- **الوصول إلى البيانات القائم على ORM**
- **تعريفات الواجهات القائمة على XML**
- **قواعد الأمان والتحكم في الوصول**

### المكدس التقني

- **الخلفية**: Python 3.x مع إطار عمل Odoo
- **الواجهة الأمامية**: إطار عمل Odoo Web (JavaScript/XML)
- **قاعدة البيانات**: PostgreSQL (عبر Odoo ORM)
- **التقارير**: قوالب QWeb

---

## هيكل الوحدة

```
tpo_management/
├── __init__.py                 # تهيئة الوحدة
├── __manifest__.py             # بيان الوحدة
├── models/                     # نماذج Python
│   ├── __init__.py
│   ├── tpo_project.py         # نموذج المشروع الرئيسي
│   ├── boq.py                  # جدول الكميات
│   ├── project_schedule.py    # جدول المشروع
│   ├── material_submittal.py   # تقديم المواد
│   ├── technical_offer.py      # العروض الفنية
│   ├── shop_drawing.py         # رسومات الورشة
│   ├── rfi.py                  # طلب معلومات
│   ├── itr.py                  # طلب الفحص والاختبار
│   ├── change_order.py         # أوامر التغيير
│   ├── correspondence_log.py  # سجل المراسلات
│   ├── payment_application.py # طلبات الدفع
│   ├── as_built_drawing.py     # رسومات التنفيذ الفعلي
│   ├── project_handover.py     # تسليم المشروع
│   └── tpo_visit.py            # زيارات المكتب الفني
├── views/                      # واجهات XML
│   ├── menu_views.xml          # تعريفات القوائم
│   ├── tpo_project_views.xml  # واجهات المشروع
│   ├── boq_views.xml           # واجهات جدول الكميات
│   └── ...                     # ملفات الواجهات الأخرى
├── security/                   # تعريفات الأمان
│   ├── ir.model.access.csv     # حقوق الوصول
│   └── security.xml            # مجموعات المستخدمين
├── data/                       # ملفات البيانات
│   ├── sequence_data.xml       # التسلسلات
│   └── document_type_data.xml  # أنواع الوثائق
├── i18n/                       # الترجمات
│   └── ar.po                   # الترجمة العربية
└── docs/                       # الوثائق
    ├── USER_MANUAL.md
    ├── USER_MANUAL_AR.md
    ├── TECHNICAL_MANUAL.md
    └── TECHNICAL_MANUAL_AR.md
```

---

## النماذج

### النماذج الأساسية

#### 1. مشروع المكتب الفني (`tpo.project`)

**الغرض**: حاوية المشروع الرئيسية

**الحقول الرئيسية**:
- `name`: اسم المشروع
- `code`: كود المشروع (يتم إنشاؤه تلقائياً)
- `partner_id`: العميل/الشريك
- `phase`: مرحلة المشروع الحالية
- `project_manager_id`: مدير المشروع
- `technical_office_engineer_id`: المهندس الفني
- `site_engineer_id`: مهندس الموقع
- `document_controller_id`: مراقب الوثائق

**العلاقات**:
- One2many لجميع أنواع الوثائق
- حقول محسوبة لأعداد الوثائق

**الطرق**:
- `_compute_document_counts()`: يحسب أعداد الوثائق
- `name_get()`: اسم العرض المخصص مع الكود

#### 2. جدول الكميات (`tpo.boq`)

**الغرض**: جدول الكميات

**الحقول الرئيسية**:
- `name`: مرجع جدول الكميات
- `project_id`: المشروع المرتبط
- `state`: الحالة (مسودة، مقدّم، معتمد، مرفوض)
- `total_amount`: الإجمالي المحسوب
- `line_ids`: One2many إلى `tpo.boq.line`

**الطرق**:
- `action_submit()`: تقديم للموافقة
- `action_approve()`: اعتماد جدول الكميات
- `action_reject()`: رفض جدول الكميات
- `_compute_total_amount()`: حساب الإجمالي من البنود

#### 3. رسومات الورشة (`tpo.shop.drawing`)

**الغرض**: رسومات الورشة مع تتبع المراجعات

**الحقول الرئيسية**:
- `name`: مرجع الرسم
- `discipline`: تخصص الرسم
- `revision_number`: رقم المراجعة الحالي
- `submission_log_ids`: One2many إلى إدخالات السجل
- `site_verified`: علامة التحقق من الموقع

**الطرق**:
- `action_submit()`: تقديم الرسم
- `action_resubmit()`: إعادة تقديم مع مراجعة جديدة
- `action_verify_site()`: تحديد كتحقق من الموقع

**نموذج السجل**: `tpo.shop.drawing.log`
- يتتبع جميع محاولات التقديم
- يسجل أرقام المراجعة وتغييرات الحالة

#### 4. طلب معلومات (`tpo.rfi`)

**الغرض**: طلب معلومات

**الحقول الرئيسية**:
- `name`: رقم طلب المعلومات
- `issue_type`: نوع المشكلة
- `priority`: مستوى الأولوية
- `location`: موقع الموقع
- `site_visit_required`: علامة لزيارة الموقع
- `response`: نص الرد

**الطرق**:
- `action_submit()`: تقديم طلب المعلومات
- `action_answer()`: تحديد كمجاب عليه
- `action_schedule_site_visit()`: جدولة زيارة الموقع

#### 5. طلب الفحص (`tpo.itr`)

**الغرض**: طلب الفحص والاختبار

**الحقول الرئيسية**:
- `name`: رقم طلب الفحص
- `inspection_type`: نوع الفحص
- `inspection_result`: نتيجة الفحص
- `technical_office_participated`: علامة المشاركة

**الطرق**:
- `action_submit()`: تقديم طلب الفحص
- `action_inspect()`: تحديد كفحص
- `action_approve()`: اعتماد الفحص

#### 6. أمر التغيير (`tpo.change.order`)

**الغرض**: أوامر التعديل

**الحقول الرئيسية**:
- `name`: رقم أمر التعديل
- `change_type`: نوع التغيير
- `original_amount`: مبلغ العقد الأصلي
- `revised_amount`: المبلغ المعدل
- `change_amount`: الفرق المحسوب
- `line_ids`: One2many إلى بنود أمر التغيير

**الطرق**:
- `action_submit()`: تقديم للموافقة
- `action_approve()`: اعتماد أمر التغيير
- `_compute_change_amount()`: حساب مبلغ التغيير

#### 7. طلب الدفع (`tpo.payment.application`)

**الغرض**: طلبات الدفع/الفواتير

**الحقول الرئيسية**:
- `name`: رقم الطلب
- `period_start_date`: بداية الفترة
- `period_end_date`: نهاية الفترة
- `total_amount`: الإجمالي المحسوب
- `site_verified`: علامة التحقق من الموقع
- `line_ids`: One2many إلى بنود الطلب

**الطرق**:
- `action_submit()`: تقديم الطلب
- `action_approve()`: اعتماد الطلب
- `action_verify_site()`: التحقق في الموقع

#### 8. زيارة المكتب الفني (`tpo.visit`)

**الغرض**: تتبع زيارات الموقع

**الحقول الرئيسية**:
- `name`: مرجع الزيارة
- `visit_type`: نوع الزيارة
- `location`: موقع الموقع
- `purpose`: غرض الزيارة
- `findings`: نتائج الزيارة
- `recommendations`: التوصيات
- علاقات Many2many متعددة للوثائق ذات الصلة

**الطرق**:
- `action_start()`: بدء الزيارة
- `action_complete()`: إكمال الزيارة

---

## الواجهات

### أنواع الواجهات

1. **عروض القائمة**: عرض السجلات بتنسيق الجدول
2. **عروض النموذج**: تحرير السجل التفصيلي
3. **عروض Kanban**: عرض قائم على البطاقات (إن تم تنفيذه)
4. **عروض البحث**: التصفية والبحث

### ميزات الواجهة الرئيسية

- **أشرطة الحالة**: مؤشرات سير العمل المرئية
- **الأزرار الذكية**: وصول سريع للسجلات ذات الصلة
- **قوائم قابلة للتحرير**: تحرير مضمن لعناصر البنود
- **مرفقات الوثائق**: رفع الملفات وإدارتها
- **المحادثة**: تتبع النشاطات والرسائل

---

## الأمان

### مجموعات المستخدمين

معرفة في `security/security.xml`:

1. **مدير المكتب الفني** (`group_tpo_manager`)
   - وصول كامل لجميع الميزات

2. **مهندس المكتب الفني** (`group_tpo_technical_office_engineer`)
   - الوصول إلى الوثائق الفنية

3. **مهندس الموقع** (`group_tpo_site_engineer`)
   - الوصول إلى وثائق الموقع

4. **مراقب الوثائق** (`group_tpo_document_controller`)
   - الوصول إلى المراسلات والسجلات

5. **مدير المشروع** (`group_tpo_project_manager`)
   - الوصول إلى ميزات إدارة المشروع

### حقوق الوصول

معرفة في `security/ir.model.access.csv`:

- أذونات CRUD القياسية لكل نموذج
- التحكم في الوصول القائم على المجموعة
- جميع النماذج متاحة لـ base.group_user افتراضياً

---

## سير العمل

### تدفقات حالة الوثيقة

#### التدفق القياسي
```
مسودة → مقدّم → معتمد/مرفوض
```

#### مع إعادة التقديم
```
مسودة → مقدّم → مرفوض → إعادة تقديم → مقدّم → معتمد
```

#### تدفق طلب الدفع
```
مسودة → مقدّم → قيد المراجعة → معتمد → مدفوع
```

### إدارة الحالة

يتم إدارة الحالات من خلال:
- **أداة شريط الحالة**: مؤشر الحالة المرئي
- **طرق الإجراء**: طرق انتقال الحالة
- **الحقول المحسوبة**: حسابات تعتمد على الحالة

---

## نقاط التكامل

### وحدات Odoo القياسية

1. **وحدة المشروع** (`project`)
   - روابط إلى `project.project` للتكامل

2. **وحدة الحسابات** (`account`)
   - يمكن لطلبات الدفع الربط بالفواتير

3. **وحدة البريد** (`mail`)
   - تكامل المحادثة لجميع النماذج
   - تتبع النشاطات
   - إشعارات الرسائل

4. **وحدة الوثائق** (`document`)
   - دعم مرفقات الملفات

### التكاملات الخارجية

- **تخزين الملفات**: نظام مرفقات Odoo القياسي
- **البريد الإلكتروني**: عبر وحدة البريد
- **التقارير**: قوالب QWeb لتقارير PDF

---

## دليل التخصيص

### إضافة نوع وثيقة جديد

1. **إنشاء نموذج** (`models/new_document.py`):
```python
class TPONewDocument(models.Model):
    _name = 'tpo.new.document'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    
    name = fields.Char(required=True)
    project_id = fields.Many2one('tpo.project', required=True)
    state = fields.Selection([...])
    # أضف حقول أخرى
```

2. **إنشاء واجهات** (`views/new_document_views.xml`):
```xml
<record id="view_tpo_new_document_form" model="ir.ui.view">
    <!-- تعريف عرض النموذج -->
</record>
```

3. **إضافة قائمة** (`views/menu_views.xml`):
```xml
<menuitem name="وثيقة جديدة" 
          parent="menu_tpo_root" 
          action="action_tpo_new_document"/>
```

4. **إضافة أمان** (`security/ir.model.access.csv`):
```csv
access_tpo_new_document_user,tpo.new.document.user,model_tpo_new_document,base.group_user,1,1,1,1
```

5. **تحديث البيان** (`__manifest__.py`):
```python
'data': [
    # ... الملفات الموجودة
    'views/new_document_views.xml',
]
```

### توسيع النماذج الموجودة

استخدم `_inherit` لتوسيع النماذج:

```python
class TPOProjectExtension(models.Model):
    _inherit = 'tpo.project'
    
    new_field = fields.Char(string='حقل جديد')
    
    def new_method(self):
        # منطق مخصص
        pass
```

### سير العمل المخصص

تجاوز طرق الإجراء لتخصيص سير العمل:

```python
def action_submit(self):
    # التحقق المخصص
    if not self.custom_validation():
        raise UserError(_("فشل التحقق"))
    
    # استدعاء الطريقة الأصلية
    super().action_submit()
    
    # منطق إضافي
    self.send_notification()
```

---

## استكشاف الأخطاء

### المشاكل الشائعة

#### 1. الوثائق لا تظهر في المشروع

**المشكلة**: الوثائق منشأة ولكن لا تظهر في عرض المشروع

**الحل**:
- تحقق من أن `project_id` مضبوط بشكل صحيح
- تحقق من حقوق الوصول
- تحقق من مرشحات النطاق في الواجهات

#### 2. أرقام المراجعة لا تزيد

**المشكلة**: إعادة التقديم لا تزيد المراجعة

**الحل**:
- تحقق من طريقة `action_resubmit()`
- تحقق من أن حقل `revision_number` يتم تحديثه
- تحقق من أخطاء التحقق

#### 3. سجل التقديم لا يتم إنشاؤه

**المشكلة**: إدخالات السجل لا يتم إنشاؤها عند التقديم

**الحل**:
- تحقق من طريقة `action_submit()`
- تحقق من وجود نموذج السجل
- تحقق من أخطاء الصلاحيات

#### 4. الحقول المحسوبة لا تتحدث

**المشكلة**: الإجماليات المحسوبة لا يتم تحديثها

**الحل**:
- تحقق من مزخرف `@api.depends`
- تحقق من أن التبعيات صحيحة
- استخدم `invalidate_recordset()` إذا لزم الأمر

### نصائح التصحيح

1. **تفعيل وضع المطور**: الوصول إلى الميزات التقنية
2. **التحقق من السجلات**: مراجعة سجلات خادم Odoo
3. **استخدام المصحح**: تعيين نقاط التوقف في كود Python
4. **الاختبار في وحدة التحكم**: استخدام Odoo shell للاختبار
5. **التحقق من قاعدة البيانات**: استعلامات SQL المباشرة للتحقق

### تحسين الأداء

1. **فهرسة الحقول**: إضافة فهارس قاعدة البيانات للحقول التي يتم البحث فيها بشكل متكرر
2. **العمليات المجمعة**: استخدام `create()` مع `vals_list` للعمليات المجمعة
3. **التحميل الكسول**: استخدام `read_group()` للتجميعات
4. **إدارة الذاكرة المؤقتة**: استخدام صحيح لـ `invalidate_recordset()`

---

## أفضل الممارسات

### تنظيم الكود

1. **فصل النماذج**: نموذج واحد لكل ملف
2. **تنظيم الواجهات**: تجميع الواجهات ذات الصلة
3. **الأمان أولاً**: تعريف حقوق الوصول مبكراً
4. **الوثائق**: تعليق المنطق المعقد

### معايير التسمية

1. **النماذج**: `tpo.model.name` (أحرف صغيرة مع شرطات سفلية)
2. **الحقول**: `field_name` (أحرف صغيرة مع شرطات سفلية)
3. **الطرق**: `action_method_name()` (بادئة action للأزرار)
4. **الواجهات**: `view_model_type` (أسماء وصفية)

### سلامة البيانات

1. **الحقول المطلوبة**: حدد الحقول الحرجة كمطلوبة
2. **القيود**: استخدم `@api.constrains` للتحقق
3. **القيم الافتراضية**: قدم قيماً افتراضية معقولة
4. **Onchange**: استخدم `@api.onchange` لمنطق الواجهة

---

## مرجع API

### الأنماط الشائعة

#### إنشاء السجلات
```python
self.env['tpo.boq'].create({
    'name': 'BOQ-001',
    'project_id': project_id,
    'date': fields.Date.today(),
})
```

#### البحث عن السجلات
```python
boqs = self.env['tpo.boq'].search([
    ('project_id', '=', project_id),
    ('state', '=', 'approved'),
])
```

#### تحديث السجلات
```python
record.write({
    'state': 'approved',
    'approval_date': fields.Date.today(),
})
```

#### الحقول المحسوبة
```python
@api.depends('line_ids.amount')
def _compute_total(self):
    for record in self:
        record.total = sum(record.line_ids.mapped('amount'))
```

---

## تاريخ الإصدارات

- **19.0.1.0.0**: الإصدار الأولي
  - نظام إدارة الوثائق الكامل
  - جميع مراحل سير العمل الثلاث
  - تتبع زيارات المكتب الفني
  - التكامل مع وحدة التقارير

---

**آخر تحديث**: نوفمبر 2025

